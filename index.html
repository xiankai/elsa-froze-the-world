<!DOCTYPE html>

<html lang="en">
	<head>
	    <meta charset="utf-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
	    <title>Elsa Froze The World</title>

		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
	</head>

	<body class="container">
		<div class="row">
			<form id="mapform" action="#">
				<div class="input-group">
					<input id="mapinput" class="form-control" type="text" placeholder="Search Google Maps"/>
					<span class="input-group-btn">
						<button class="btn btn-default" type="button">Search</button>
					</span>
				</div>
			</form>
		</div>

		<div class="row">
			<div id="mapdiv" style="height: 400px;"></div>
		</div>

		<div class="row">
			<form id="saveform" action="#">
				<div class="form-group">
					<label for="selected_location">Current Location</label>
					<input type="text" class="form-control" id="selected_location" disabled/>
				</div>
				<div class="form-group">
					<label for="user">Your Reddit Username (optional)</label>
					<div class="input-group">
						<span class="input-group-btn">
							<button class="btn btn-default" type="button">/u/</button>
						</span>
						<input type="text" class="form-control" name="user" id="user" placeholder=""/>
					</div>
				</div>
				<div class="col-xs-6">
					<button class="btn btn-success btn-block">Submit</button>
				</div>
				<div class="col-xs-6">
					<a href="http://xiankai.github.io/frozen-demographics" class="btn btn-primary btn-block" id="poll_results">View Poll Results</a>
				</div>
			</form>
		</div>

		<!-- Latest jQuery -->
		<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
		<!-- Latest compiled and minified JavaScript -->
		<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
		<script src="http://maps.googleapis.com/maps/api/js?v=3.14&amp;sensor=false&amp;key=AIzaSyD84HytJHsRosY22GYIhCEVpYQtl7FEPSY"></script>
		<script src="http://www.parsecdn.com/js/parse-1.2.18.min.js"></script>
		<script>
			// Google Maps
			var current_location;
			google.maps.event.addDomListener(window, "load", function() {
				var centering = false;

				// initialize map
				var map = new google.maps.Map(document.getElementById("mapdiv"), {
					center: new google.maps.LatLng(34.155478, -118.322957),
					zoom: 17,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				});

				var geocodeCallback = function(results, status) {
					if (status == google.maps.GeocoderStatus.OK) {
						current_location = results[0];

						$('#selected_location').val(current_location.formatted_address);
						if (current_location.geometry.viewport) {
							map.fitBounds(current_location.geometry.viewport);
						}
						else {
							map.setCenter(current_location.geometry.location);
						}
					} else if (status == google.maps.GeocoderStatus.ZERO_RESULTS) {
						alert("Sorry, the geocoder failed to locate the specified address.");
					} else {
						alert("Sorry, the geocoder failed with an internal error.");
					}
				}
				
				// initialize marker
				var marker = new google.maps.Marker({
					position: map.getCenter(),
					draggable: true,
					map: map
				});
				
				// initialize geocoder
				var geocoder = new google.maps.Geocoder();
				google.maps.event.addDomListener(document.getElementById("mapform"), "submit", function(domEvent) {
					if (domEvent.preventDefault){
						domEvent.preventDefault();
					} else {
						domEvent.returnValue = false;
					}
					geocoder.geocode({
						address: $('#mapinput').val()
					}, geocodeCallback);
				});

				// intercept map and marker movements
				google.maps.event.addListener(map, "idle", function() {
					// prevent re-interception
					if (centering) {
						centering = false;
						return;
					} else {
						centering = true;	
					}

					var center = map.getCenter();
					marker.setPosition(center);

					// reverse geocode
					var latLng = new google.maps.LatLng(center.lat(), center.lng());
					geocoder.geocode({
						latLng: latLng
					}, geocodeCallback);
				});

				// center map
				google.maps.event.addListener(marker, "dragend", function(mapEvent) {
					map.panTo(mapEvent.latLng);
				});
			});

			// Storage
			Parse.initialize("T0eL2XdYC7LrjI4gFuvA5rJntBpDuYuZaszKt8tC", "pcq6oIWXRSdCFZjLCbwc3RNYqUaOZbnLhNjgabs1");

			// Form submit
			$('#saveform').on('submit', function(e) {
				e.preventDefault();
				var loc = current_location.address_components;
				var form_data = {};

				// Extract human readable information
				$.inArray(loc[i]);
				for (var i in loc) {
					var types = loc[i].types;
					var longname = loc[i].long_name;

					if ($.inArray('country', types) != -1) {
						form_data['country'] = longname;
						continue;
					}

					if ($.inArray('administrative_area_level_2', types) != -1) {
						form_data['county'] = longname;
						continue;
					}

					if ($.inArray('administrative_area_level_1', types) != -1) {
						form_data['state'] = longname;
						continue;
					}

					if ($.inArray('locality', types) != -1) {
						form_data['locality'] = longname;
						continue;
					}

					if ($.inArray('neighbourhood', types) != -1) {
						form_data['neighbourhood'] = longname;
						continue;
					}
				}

				// Extract coords
				var loc2 = current_location.geometry.location;
				form_data['lat'] = loc2.ob;
				form_data['lng'] = loc2.pb;

				// Reddit /u/sername
				form_data['user'] = $('#user').val();

				var FrozenPoll = Parse.Object.extend("FrozenPoll");
				var frozenPoll = new FrozenPoll();
				frozenPoll.save(form_data, {
					success: function() {
						// Redirect to results
						location.href = $('#poll_results').attr('href');
					},
					error: function(frozenPoll, error) {
						alert('Failed to save to Parse: ' + error.description);
					}
				});
			});
		</script>
	</body>
</html>